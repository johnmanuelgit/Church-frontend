<div class="container mx-auto p-5">
  <h2 class="text-2xl font-bold mb-4 text-center">LCF Tax Management</h2>

  <!-- Family Head Selector -->
  <div class="mb-6">
    <label for="familyHead" class="block mb-2 font-bold">Select Family Head:</label>
    <select 
      id="familyHead"
      [(ngModel)]="selectedHead" 
      (change)="selectHead()" 
      class="w-full p-2 border rounded"
    >
      <option value="">Select Family Head</option>
      <option *ngFor="let head of familyHeads" [value]="head.id">
        {{ head.name }}
      </option>
    </select>
  </div>

  <!-- Year Selector -->
  <div class="mb-6">
    <label class="block mb-2 font-bold">Select Year:</label>
    <select [(ngModel)]="selectedYear" (change)="onYearChange()" class="w-full p-2 border rounded">
      <option *ngFor="let year of availableYears" [value]="year">{{ year }}</option>
      <option value="all">All Years</option>
    </select>
  </div>

  <!-- No Family Members -->
  <div *ngIf="familyMembers.length === 0 && selectedHead" class="text-center p-4 mb-4 bg-yellow-100 border border-yellow-400 rounded">
    No family members found for the selected head.
  </div>

  <!-- Family Members Table -->
  <div *ngIf="familyMembers.length > 0" class="mt-4">
    <h3 class="text-xl font-semibold mb-3">Family Members</h3>

    <table class="table-auto w-full border border-collapse">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">Name</th>
          <th class="border p-2">DOB</th>
          <th class="border p-2">Age</th>
          <th class="border p-2">Tax Amount</th>
          <th class="border p-2">Status</th>
          <th class="border p-2">Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let member of familyMembers" class="hover:bg-gray-100">
          <td class="border p-2">
            {{ member.name }}
            <span *ngIf="member.id.toString() === selectedHead" class="text-xs text-blue-600 italic ml-1">(Head)</span>
          </td>
          <td class="border p-2">{{ member.dob }}</td>
          <td class="border p-2">{{ getAge(member.dob) }}</td>
          <td class="border p-2">₹{{ calculateTax(member.dob) }}</td>
          <td class="border p-2" [ngClass]="member.tax?.[selectedYear] ? 'text-green-600' : 'text-red-600'">
            {{ member.tax?.[selectedYear] ? 'Paid' : 'Unpaid' }}
          </td>
          <td class="border p-2">
            <button 
              *ngIf="!member.tax?.[selectedYear]" 
              (click)="markAsPaid(member)" 
              class="text-blue-600 underline hover:text-blue-800"
            >
              Mark as Paid
            </button>
            <button 
              *ngIf="member.tax?.[selectedYear]" 
              (click)="editPayment(member)" 
              class="text-red-600 underline hover:text-red-800"
            >
              Click to Unpaid
            </button>
          </td>
        </tr>
      </tbody>
      <tfoot class="bg-gray-100 font-semibold">
        <tr>
          <td class="border p-2" colspan="3">Total</td>
          <td class="border p-2">₹{{ getTotalTax() }}</td>
          <td class="border p-2" colspan="2">{{ getPaidCount() }} / {{ familyMembers.length }} paid</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- All Members Table -->
  <div *ngIf="!selectedHead && members.length > 0" class="mt-6">
    <h3 class="text-xl font-semibold mb-3">All Members</h3>

    <table class="table-auto w-full border border-collapse">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">Name</th>
          <th class="border p-2">Age</th>
          <th class="border p-2">Tax Amount</th>
          <th class="border p-2">Status</th>
          <th class="border p-2">Family Head</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let member of members" class="hover:bg-gray-100">
          <td class="border p-2">{{ member.name }}</td>
          <td class="border p-2">{{ getAge(member.dob) }}</td>
          <td class="border p-2">₹{{ calculateTax(member.dob) }}</td>
          <td class="border p-2" [ngClass]="member.tax?.[selectedYear] ? 'text-green-600' : 'text-red-600'">
            {{ member.tax?.[selectedYear] ? 'Paid' : 'Unpaid' }}
            <button 
              *ngIf="!member.tax?.[selectedYear]" 
              (click)="markAsPaid(member)" 
              class="ml-2 text-blue-600 underline text-sm hover:text-blue-800"
            >
              Mark as Paid
            </button>
            <button 
              *ngIf="member.tax?.[selectedYear]" 
              (click)="editPayment(member)" 
              class="ml-2 text-red-600 underline text-sm hover:text-red-800"
            >
              Click to Unpaid
            </button>
          </td>
          <td class="border p-2">{{ member.familyHeadName || member.familyHead }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="p-4 mb-4 bg-red-100 border border-red-400 text-red-700 rounded">
    {{ errorMessage }}
  </div>

  <!-- Summary Section -->
  <div *ngIf="selectedYear && (familyMembers.length > 0 || members.length > 0)" class="mb-4 p-4 bg-gray-100 rounded border">
    <h4 class="font-semibold text-lg mb-2">Summary for {{ selectedYear === 'all' ? 'All Years' : selectedYear }}</h4>
    <ul class="list-disc pl-5 space-y-1">
      <li><strong>Total Members:</strong> {{ getSummary().totalMembers }}</li>
      <li><strong>Paid Members Count:</strong> {{ getSummary().paidCount }}</li>
      <li><strong>Unpaid Members Count:</strong> {{ getSummary().unpaidCount }}</li>
      <li><strong>Total Tax (All Members):</strong> ₹{{ getSummary().totalTax }}</li>
      <li><strong>Total Paid Amount:</strong> ₹{{ getSummary().paidAmount }}</li>
      <li><strong>Total Unpaid Amount:</strong> ₹{{ getSummary().unpaidAmount }}</li>
      <li><strong>Paid + Unpaid Amount:</strong> ₹{{ getSummary().paidPlusUnpaidAmount }}</li>
    </ul>
  </div>
</div>
